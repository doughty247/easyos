# EasyOS Development Handoff Documentation

**Date**: 3 November 2025  
**Project**: EasyOS - NixOS-based declarative appliance OS  
**Repository**: `doughty247/easyos` (branch: `main`)

---

## Project Overview

EasyOS is a NixOS-based appliance operating system designed for headless servers with:
- **Single-file configuration**: Edit `/etc/easy/config.json`, apply with one command
- **SteamOS-style update channels**: stable/beta/preview
- **Production features**: TPM2-backed LUKS encryption, Btrfs with compression, router-grade WiFi hotspot, CAKE QoS, network auto-profiling, web UI
- **Installation flow**: Bootable ISO → interactive installer → configured system

---

## User Preferences (CRITICAL)

### Development Philosophy
1. **Production-ready solutions only** - No bandaid fixes, hacks, or workarounds
2. **Do not ask permission** - Infer intent, act proactively, implement changes directly
3. **Agent mindset** - Keep going until the task is fully resolved; don't stop at partial fixes
4. **Complete solutions** - If fixing A breaks B, fix both in the same turn

### Technical Standards
- **No heredoc corruption**: Never embed large scripts in Nix; use external files with `source = ./path`
- **Robust error handling**: Tools must work in CI, pipes, terminals, and non-interactive modes
- **Conditional imports**: Use `lib.optional (builtins.pathExists path) path` for installer-generated configs
- **Git-tracked sources**: Nix can only include files tracked by git; ensure `git add` before builds
- **TTY safety**: Docker/shell scripts must detect TTY availability and gracefully handle absence

### Communication Style
- **Concise and direct**: Skip filler phrases like "Sounds good" or "I will now..."
- **Action-first**: Start with what you're doing, not acknowledgements
- **Delta updates**: Don't restate unchanged plans or repeat resolved issues
- **Progress cadence**: Report after 3-5 tool calls or when editing multiple files
- **Fenced commands**: Use proper markdown code blocks for all terminal commands

---

## Current State

### What Works
✅ **Clean flake architecture**
- `mkEasyOS`: Installed system configuration with conditional imports for hardware/bootloader/credentials/encryption
- `mkISO`: Live ISO with embedded installer and flake tarball for offline install
- Channel-aware kernel selection (stable/beta/preview)
- All feature modules imported: `easyos.nix`, `network-performance.nix`, `network-autodiscovery.nix`, `hotspot.nix`, `backup.nix`, `storage-expansion.nix`, `webui.nix`

✅ **External installer script**
- `scripts/easyos-install.sh`: Full interactive installer with TPM2/LUKS, Btrfs, QR recovery keys
- Prompt deduplication fixed (TTY fd 3 with stdout fallback)
- Generates `hardware-configuration.nix`, `easy-bootloader.nix`, `easy-credentials.nix`, `easy-encryption.nix` at install time

✅ **Build infrastructure**
- `build-iso-docker.sh`: Docker/Podman wrapper with:
  - Robust TTY detection (works in CI, pipes, terminals)
  - `--non-interactive` mode for automation
  - Change detection (skip unnecessary rebuilds)
  - `--vm` for QEMU testing (UEFI preferred, BIOS fallback)
  - Artifact export (build logs, installer snapshot, closure info)
  - Persistent volumes for `/nix` store and cache

✅ **Network-based install with caching**
- Installer clones latest flake from GitHub during install
- Nix cache speeds up package downloads
- Always installs the latest committed version from main branch

✅ **ISO building**
- No TTY errors in any environment
- Build completed successfully (1.7G ISO)
- VM launched and booted to installer

### Known Issues (From Screenshot)

⚠️ **Install-time NixOS evaluation failure**
```
error:
Failed to build 'allSystemOpts' option does not specify your root file system.
You must set the option 'boot.loader.grub.devices' or 'boot.loader.grub.mirroredBoots' to make the system bootable.
```

**Root Cause Analysis**:
- The installer runs `nixos-install --flake /mnt/etc/nixos/easyos#easyos-stable`
- At that point, the flake is evaluating the installed config (`mkEasyOS`)
- Prior to the latest fix, `mkEasyOS` did **not** import:
  - `./hardware-configuration.nix` (contains root filesystem declarations)
  - `./easy-bootloader.nix` (contains GRUB/systemd-boot config)
  - `./easy-credentials.nix` (contains user password hashes)
  - `./easy-encryption.nix` (contains LUKS device config)
- These files are **generated by the installer** and must be **conditionally imported** by the installed system config

**Fix Applied**:
- Modified `easyos/flake.nix` `mkEasyOS` function to:
  ```nix
  # Helper to optionally import files the installer writes
  maybeImport = path: lib.optional (builtins.pathExists path) path;
  
  modules =
    [ /* base modules */ ]
    ++ (maybeImport ./hardware-configuration.nix)
    ++ (maybeImport ./easy-bootloader.nix)
    ++ (maybeImport ./easy-credentials.nix)
    ++ (maybeImport ./easy-encryption.nix);
  ```
- This ensures:
  - Root filesystem is defined (from `hardware-configuration.nix`)
  - Bootloader is configured (UEFI → systemd-boot, BIOS → GRUB with device)
  - No "system.stateVersion is not set" warning
  - No GRUB devices assertion

**Verification Status**: ISO rebuilt with fix; VM booted to installer. **Install not yet completed in VM** to verify fix resolves the error.

---

## File Structure

```
easyos/
├── flake.nix                      # Main flake: mkEasyOS (installed), mkISO (live)
├── flake.lock                     # Pinned Nixpkgs 24.11, Home Manager release-24.11
├── build-iso-docker.sh            # Cross-distro build wrapper (Docker/Podman)
├── scripts/
│   └── easyos-install.sh          # Interactive installer (external, git-tracked)
├── modules/
│   ├── easyos.nix                 # Core: bootloader, filesystems, users, packages
│   ├── network-performance.nix    # CAKE QoS, BBR congestion control
│   ├── network-autodiscovery.nix  # Per-network bandwidth profiling
│   ├── hotspot.nix                # Router-grade WiFi AP with NAT/DHCP/DNS
│   ├── backup.nix                 # Btrfs snapshot automation
│   ├── storage-expansion.nix      # Dynamic storage management
│   └── webui.nix                  # Web UI for /etc/easy/config.json editing
├── etc/easy/
│   └── config.example.json        # Configuration schema
├── iso-output/                    # Built ISOs land here
│   └── _artifacts/                # Build metadata, logs, installer snapshot
├── hardware-configuration.nix     # (Generated at install time)
├── easy-bootloader.nix            # (Generated at install time)
├── easy-credentials.nix           # (Generated at install time)
├── easy-encryption.nix            # (Generated at install time, if encryption enabled)
└── README.md                      # User-facing docs
```

---

## Remaining Work

### 1. Validate Install Fix (High Priority)

**Task**: Confirm the conditional import fix resolves the NixOS evaluation error during `nixos-install`.

**Steps**:
1. Launch VM with existing ISO:
   ```bash
   cd /home/bazzite/Documents/easy/easyos
   ./build-iso-docker.sh --vm
   ```

2. Inside the VM, run the installer:
   ```bash
   sudo /etc/easyos-install.sh
   ```

3. During install:
   - Select target device (e.g., `/dev/vda`)
   - Choose hostname, admin username, passwords
   - Enable or skip TPM2 encryption (TPM available in UEFI VM)
   - Proceed through partitioning, filesystem creation

4. **Watch for the error**:
   - Previous error: `Failed to build 'allSystemOpts' option does not specify your root file system`
   - Expected: Clean `nixos-install` execution without filesystem or bootloader assertions

5. If successful:
   - Reboot into installed system
   - Verify autologin, web UI at `http://<ip>:8088`, `easy-help` command

6. If error persists:
   - Copy `/tmp/easyos-install.log` from VM to host
   - Check which files exist in `/mnt/etc/nixos/easyos/` after config generation
   - Inspect flake evaluation: `nix eval --impure /mnt/etc/nixos/easyos#nixosConfigurations.easyos-stable.config.fileSystems`

**Acceptance Criteria**:
- `nixos-install` completes without "root file system" or "boot.loader.grub.devices" errors
- Installed system boots to login prompt
- `/etc/easy/config.json` is present and editable
- Web UI accessible after networking comes up

---

### 2. Improve Installer UX (Medium Priority)

**Enhancements**:
- **Pre-flight checks**: Verify `/etc/nixos/easyos.tar.gz` exists before proceeding
- **Error messages**: Surface Nix build errors cleanly (not just raw trace)
- **Progress indicators**: Show stage completion (partitioning ✓, filesystems ✓, etc.)
- **Rollback on failure**: If `nixos-install` fails, offer to unmount and retry

**Implementation Notes**:
- Edit `scripts/easyos-install.sh`
- Add `set +e` around `nixos-install`, capture exit code, display last 50 lines of error on failure
- Consider `dialog` or `whiptail` for TUI menus (must be added to ISO packages)

---

### 3. Testing Matrix (Medium Priority)

**Scenarios to Validate**:
- [ ] UEFI + TPM2 encryption → systemd-boot, auto-unlock
- [ ] UEFI + no encryption → systemd-boot, no LUKS
- [ ] BIOS + no encryption → GRUB, no LUKS
- [ ] BIOS + encryption (no TPM) → GRUB, manual passphrase at boot
- [ ] Network install → clones from GitHub, uses binary cache
- [ ] Channel selection (stable/beta/preview) → kernel packages match

**Test Harness**:
```bash
# Create test matrix script
./test-vm-scenarios.sh --uefi --tpm --encrypt
./test-vm-scenarios.sh --uefi --no-encrypt
./test-vm-scenarios.sh --bios --no-encrypt
./test-vm-scenarios.sh --bios --encrypt-no-tpm
```

---

### 4. CI/Automation (Low Priority)

**Goal**: Automate ISO builds and basic smoke tests.

**GitHub Actions Workflow**:
```yaml
name: Build EasyOS ISO

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build ISO (non-interactive)
        run: |
          cd easyos
          ./build-iso-docker.sh --non-interactive --no-artifacts
      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: easyos-iso
          path: easyos/iso-output/*.iso
```

**Smoke Test**:
- Boot ISO in headless QEMU (VNC or serial console)
- Verify installer launches
- Check `/etc/nixos/easyos.tar.gz` presence
- Optionally: automate installer with expect script

---

### 5. Documentation Updates (Low Priority)

**README.md Additions**:
- Architecture diagram (ISO flow, installed system flow)
- Channel upgrade procedure (`/etc/easy/channel` + rebuild)
- Troubleshooting section (common errors, log locations)
- Development workflow (modify flake → rebuild ISO → test in VM)

**Wiki/Docs Site**:
- User guide: Installation walkthrough with screenshots
- Admin guide: Configuration reference, module options
- Developer guide: How to add new modules, testing methodology

---

## Key Technical Decisions

### Why External Installer Script?
- **Avoids heredoc corruption**: Previous `flake.nix` had 900+ line embedded script that got mangled by editors
- **Version control**: Easier to review diffs, apply fixes
- **Testability**: Can run `shellcheck` and test locally before embedding in ISO

### Why Conditional Imports?
- **Development vs. Installed**: During ISO build, these files don't exist; during install, they must be imported
- **Nix purity**: `builtins.pathExists` is impure but required; force with `--impure` flag
- **Separation of concerns**: Installer generates hardware-specific config; flake provides base system

### Why Docker Wrapper?
- **Cross-distro**: Works on Bazzite, Fedora, Ubuntu, Arch, etc. (anything with Docker/Podman)
- **Reproducibility**: nixos/nix:latest container pins Nix version
- **Store persistence**: Docker volumes cache `/nix` for faster rebuilds

### Why GitHub Cloning During Install?
- **Always fresh**: Installs the latest committed flake from main branch
- **Simpler**: No store path confusion or tarball extraction issues
- **Cached**: Nix binary cache speeds up package downloads significantly
- **Required**: Network connectivity needed during install (checked by installer)

---

## Common Pitfalls & Solutions

### Issue: "the input device is not a TTY"
**Cause**: Docker forced `-it` when stdin/stdout weren't TTYs  
**Solution**: Detect TTY dynamically; use `--non-interactive` flag  
**Code**: `build-iso-docker.sh` lines 227-235

### Issue: Nix can't find installer script
**Cause**: File not tracked by git  
**Solution**: `git add scripts/easyos-install.sh` before building  
**Prevention**: Check `git status` in preflight

### Issue: "fileSystems option does not specify your root file system"
**Cause**: `hardware-configuration.nix` not imported into installed config  
**Solution**: Use `maybeImport` helper with `lib.optional`  
**Code**: `flake.nix` mkEasyOS modules list

### Issue: Prompt text duplicated in installer
**Cause**: Writing to both fd 3 and stdout  
**Solution**: Write prompt **only once** (prefer fd 3 if open)  
**Code**: `scripts/easyos-install.sh` `prompt()` and `prompt_secret()` functions

### Issue: Build fails with heredoc mismatch
**Cause**: Corrupted heredoc markers in embedded scripts  
**Solution**: Never embed scripts; use external files  
**Prevention**: Preflight checks in build script (lines 368-379)

---

## Development Commands

### Build ISO Locally
```bash
cd /home/bazzite/Documents/easy/easyos
./build-iso-docker.sh --force
```

### Build + Test in VM
```bash
./build-iso-docker.sh --vm --force
```

### Non-Interactive Build (CI)
```bash
./build-iso-docker.sh --non-interactive
```

### Quick Flake Checks
```bash
# Evaluate installed config (will fail without hardware-configuration.nix)
nix eval --impure .#nixosConfigurations.easyos.config.system.stateVersion

# Evaluate ISO config
nix eval --impure .#nixosConfigurations.iso.config.isoImage.volumeID

# Check if path exists helper works
nix eval --impure --expr 'builtins.pathExists ./hardware-configuration.nix'
```

### Extract Installer from ISO
```bash
cd iso-output/_artifacts
cat easyos-install.sh  # Latest build's installer
```

### Inspect Installed System (Post-Install)
```bash
# Inside installed system
cat /etc/easy/config.json
cat /etc/easy/channel
nixos-rebuild --flake /etc/nixos/easyos#easyos switch --impure
```

---

## Contact & Resources

- **Repository**: https://github.com/doughty247/easyos
- **Nixpkgs Channel**: 24.11 (stable)
- **Home Manager**: release-24.11
- **Key Dependencies**: NetworkManager, systemd-cryptenroll, qrencode, Btrfs-progs, cryptsetup

---

## Final Notes

**Current Blocker**: Install-time evaluation error visible in screenshot. The fix has been applied (conditional imports in mkEasyOS), but **not yet validated** via full install in VM.

**Next Immediate Step**: Run VM install to completion, verify no filesystem/bootloader assertions, and document outcome.

**Handoff Readiness**: 90% — fix is implemented; verification pending. Once install succeeds, all major infrastructure is complete.

**User Satisfaction**: User values production-grade solutions, autonomous problem-solving, and complete fixes over partial patches. Deliver end-to-end functionality without asking for permission.

---

**End of Handoff Document**
